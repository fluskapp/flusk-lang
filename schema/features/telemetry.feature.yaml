name: telemetry
description: OTel ingestion and AI usage tracking â€” the Observation pillar
version: 1.0.0

entities:
  - name: agent-device
    fields:
      - name: org_id
        type: integer
        indexed: true
      - name: device_id
        type: string
        unique: true
      - name: hostname
        type: string
      - name: os
        type: string
      - name: arch
        type: string
      - name: agent_version
        type: string
      - name: employee_email
        type: string
        indexed: true
        nullable: true
      - name: last_seen_at
        type: datetime
      - name: status
        type: enum
        values: [active, offline, revoked]
        default: active
    queries:
      - findByDeviceId: { by: device_id }
      - findByOrg: { by: org_id }
      - findActiveByOrg: { where: "org_id = ? AND status = 'active'" }
      - findOffline: { where: "status = 'active' AND last_seen_at < datetime('now', '-24 hours')" }

  - name: telemetry-event
    fields:
      - name: org_id
        type: integer
        indexed: true
      - name: device_id
        type: string
        indexed: true
      - name: trace_id
        type: string
        indexed: true
      - name: span_id
        type: string
      - name: provider
        type: string
        indexed: true
      - name: model
        type: string
        indexed: true
      - name: tool_name
        type: string
        indexed: true
        nullable: true
      - name: input_tokens
        type: integer
        default: 0
      - name: output_tokens
        type: integer
        default: 0
      - name: latency_ms
        type: integer
        default: 0
      - name: cost_usd
        type: float
        default: 0
      - name: status_code
        type: integer
        default: 200
      - name: is_approved
        type: boolean
        default: false
      - name: metadata
        type: json
        nullable: true
    queries:
      - findByOrg: { by: org_id, order: "created_at DESC" }
      - findByDevice: { where: "org_id = ? AND device_id = ?", order: "created_at DESC" }
      - findByProvider: { where: "org_id = ? AND provider = ?", order: "created_at DESC" }
      - findShadowAI: { where: "org_id = ? AND is_approved = false", order: "created_at DESC" }

  - name: ai-tool
    fields:
      - name: org_id
        type: integer
        indexed: true
      - name: name
        type: string
      - name: provider
        type: string
      - name: category
        type: enum
        values: [chat, coding, image, voice, search, other]
        default: other
      - name: approved
        type: boolean
        default: false
      - name: detection_pattern
        type: string
        nullable: true
      - name: first_seen_at
        type: datetime
      - name: last_seen_at
        type: datetime
    queries:
      - findByOrg: { by: org_id }
      - findByOrgAndName: { where: "org_id = ? AND name = ?" }
      - findUnapproved: { where: "org_id = ? AND approved = false" }
    capabilities:
      - time-range

  - name: usage-daily
    description: Aggregated daily usage stats per org/device/provider
    fields:
      - name: org_id
        type: integer
        indexed: true
      - name: device_id
        type: string
        indexed: true
      - name: provider
        type: string
        indexed: true
      - name: model
        type: string
      - name: date
        type: date
        indexed: true
      - name: request_count
        type: integer
        default: 0
      - name: total_input_tokens
        type: integer
        default: 0
      - name: total_output_tokens
        type: integer
        default: 0
      - name: total_cost_usd
        type: float
        default: 0
      - name: total_latency_ms
        type: integer
        default: 0
      - name: shadow_count
        type: integer
        default: 0
    queries:
      - findByOrgAndDate: { where: "org_id = ? AND date = ?" }
      - findByOrgRange: { where: "org_id = ? AND date BETWEEN ? AND ?", order: "date ASC" }
      - findByDevice: { where: "org_id = ? AND device_id = ? AND date BETWEEN ? AND ?", order: "date ASC" }

routes:
  - name: ingest-otel
    method: POST
    path: /api/v1/telemetry/ingest
    auth: api-key
    actions:
      - validate: otel-payload
      - call: process-telemetry-batch
      - emit: telemetry-received

  - name: agent-heartbeat
    method: POST
    path: /api/v1/telemetry/heartbeat
    auth: api-key
    input:
      - name: device_id
        type: string
        required: true
      - name: hostname
        type: string
      - name: os
        type: string
      - name: arch
        type: string
      - name: agent_version
        type: string
    actions:
      - call: register-or-update-device

  - name: get-usage-summary
    method: GET
    path: /api/dashboard/usage
    auth: session
    loader: usage-summary

  - name: get-usage-by-provider
    method: GET
    path: /api/dashboard/usage/providers
    auth: session
    loader: usage-by-provider

  - name: get-usage-by-employee
    method: GET
    path: /api/dashboard/usage/employees
    auth: session
    loader: usage-by-employee

  - name: get-shadow-ai
    method: GET
    path: /api/dashboard/shadow-ai
    auth: session
    loader: shadow-ai-report

  - name: get-usage-trends
    method: GET
    path: /api/dashboard/trends
    auth: session
    loader: usage-trends

  - name: list-devices
    method: GET
    path: /api/devices
    auth: session
    loader: org-devices

  - name: revoke-device
    method: DELETE
    path: /api/devices/:deviceId
    auth: session
    actions:
      - update: agent-device

  - name: list-tools
    method: GET
    path: /api/tools
    auth: session
    loader: org-tools

  - name: approve-tool
    method: PATCH
    path: /api/tools/:toolId
    auth: session
    input:
      - name: approved
        type: boolean
        required: true
    actions:
      - update: ai-tool

functions:
  - name: process-telemetry-batch
    description: Parse OTel spans, detect provider/model, calculate cost, store events
    input:
      - name: spans
        type: array
      - name: org_id
        type: integer
      - name: device_id
        type: string
    logic:
      - map: span in input.spans
        steps:
          - "set: provider = span.attributes.gen_ai_system ?? 'unknown'"
          - "set: model = span.attributes.gen_ai_request_model ?? 'unknown'"
          - "set: input_tokens = span.attributes.gen_ai_usage_input_tokens ?? 0"
          - "set: output_tokens = span.attributes.gen_ai_usage_output_tokens ?? 0"
          - "set: latency_ms = span.duration ?? 0"
          - "set: tool = db.findOne(ai-tool, { org_id: input.org_id, name: provider })"
          - if: "!tool"
            then:
              - "set: tool = db.insert(ai-tool, { org_id: input.org_id, name: provider, provider, category: 'other', approved: false, first_seen_at: now(), last_seen_at: now() })"
              - emit: new-tool-detected
                payload:
                  org_id: "input.org_id"
                  tool_name: "provider"
                  provider: "provider"
          - "set: is_approved = tool.approved"
          - if: "!is_approved"
            then:
              - emit: shadow-ai-detected
                payload:
                  org_id: "input.org_id"
                  device_id: "input.device_id"
                  tool_name: "provider"
                  provider: "provider"
          - "set: cost_usd = input_tokens * 0.000003 + output_tokens * 0.000015"
          - "db.insert: telemetry-event, { org_id: input.org_id, device_id: input.device_id, trace_id: span.traceId, span_id: span.spanId, provider, model, input_tokens, output_tokens, latency_ms, cost_usd, is_approved }"
      - "return: { processed: input.spans.length }"

  - name: register-or-update-device
    input:
      - name: device_id
        type: string
      - name: hostname
        type: string
      - name: os
        type: string
      - name: agent_version
        type: string
      - name: org_id
        type: integer
    logic:
      - "set: existing = db.findOne(agent-device, { device_id: input.device_id })"
      - if: "existing"
        then:
          - "db.update: agent-device, { id: existing.id, hostname: input.hostname, os: input.os, agent_version: input.agent_version, last_seen_at: now(), status: 'active' }"
          - "return: existing"
        else:
          - "set: device = db.insert(agent-device, { org_id: input.org_id, device_id: input.device_id, hostname: input.hostname, os: input.os, agent_version: input.agent_version, last_seen_at: now(), status: 'active' })"
          - "return: device"

  - name: setup-default-tools
    description: Pre-populate known AI tools for a new org
    input:
      - name: org_id
        type: integer
    logic:
      - "set: defaults = [{ name: 'ChatGPT', provider: 'openai', category: 'chat' }, { name: 'GitHub Copilot', provider: 'github', category: 'coding' }, { name: 'Claude', provider: 'anthropic', category: 'chat' }, { name: 'Gemini', provider: 'google', category: 'chat' }, { name: 'Cursor', provider: 'cursor', category: 'coding' }]"
      - map: tool in defaults
        steps:
          - "db.insert: ai-tool, { org_id: input.org_id, name: tool.name, provider: tool.provider, category: tool.category, approved: false, first_seen_at: now(), last_seen_at: now() }"

  - name: aggregate-daily-usage
    description: Roll up telemetry events into daily aggregates
    input:
      - name: org_id
        type: integer
      - name: date
        type: date
    logic:
      - "set: events = db.find(telemetry-event, { org_id: input.org_id, date: input.date })"
      - "set: grouped = {}"
      - map: evt in events
        steps:
          - "set: key = evt.device_id + ':' + evt.provider + ':' + evt.model"
          - if: "!grouped[key]"
            then:
              - "set: grouped[key] = { device_id: evt.device_id, provider: evt.provider, model: evt.model, request_count: 0, total_input_tokens: 0, total_output_tokens: 0, total_cost_usd: 0, total_latency_ms: 0, shadow_count: 0 }"
          - "set: grouped[key].request_count = grouped[key].request_count + 1"
          - "set: grouped[key].total_input_tokens = grouped[key].total_input_tokens + evt.input_tokens"
          - "set: grouped[key].total_output_tokens = grouped[key].total_output_tokens + evt.output_tokens"
          - "set: grouped[key].total_cost_usd = grouped[key].total_cost_usd + evt.cost_usd"
          - "set: grouped[key].total_latency_ms = grouped[key].total_latency_ms + evt.latency_ms"
          - if: "!evt.is_approved"
            then:
              - "set: grouped[key].shadow_count = grouped[key].shadow_count + 1"
      - map: entry in grouped
        steps:
          - "db.insert: usage-daily, { org_id: input.org_id, date: input.date, device_id: entry.device_id, provider: entry.provider, model: entry.model, request_count: entry.request_count, total_input_tokens: entry.total_input_tokens, total_output_tokens: entry.total_output_tokens, total_cost_usd: entry.total_cost_usd, total_latency_ms: entry.total_latency_ms, shadow_count: entry.shadow_count }"

events:
  - name: telemetry-received
    payload:
      - name: org_id
        type: integer
      - name: device_id
        type: string
      - name: event_count
        type: integer
    triggers:
      - worker: detect-anomalies
      - worker: update-daily-aggregates

  - name: shadow-ai-detected
    payload:
      - name: org_id
        type: integer
      - name: device_id
        type: string
      - name: tool_name
        type: string
      - name: provider
        type: string
    triggers:
      - worker: create-shadow-alert

  - name: new-tool-detected
    payload:
      - name: org_id
        type: integer
      - name: tool_name
        type: string
      - name: provider
        type: string
    triggers:
      - function: auto-classify-tool

workers:
  - name: detect-anomalies
    concurrency: 3
    steps:
      - load: usage-daily
      - call: check-usage-spike
      - condition: spike-detected
      - emit: alert-triggered

  - name: update-daily-aggregates
    concurrency: 5
    steps:
      - load: telemetry-event
      - call: aggregate-daily-usage

  - name: create-shadow-alert
    concurrency: 3
    steps:
      - load: ai-tool
      - call: create-alert

commands:
  - name: telemetry
    subcommands:
      - name: stats
        description: Show telemetry statistics
        args:
          - name: org
            type: string
      - name: tools
        description: List detected AI tools
      - name: shadow
        description: Show shadow AI report
