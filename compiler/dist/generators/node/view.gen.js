const HEADER = '// @generated by flusk-lang — DO NOT EDIT\n';

const toPascalCase = (str) => str.replace(/(^|[-_ ])([a-z])/g, (_, _sep, c) => c.toUpperCase());

const routeToId = (route) => route.replace(/\$(\w+)/g, '$$$1');

const generateStatCards = (section) => {
    const widgets = (section.widgets || []).map((w) => {
        const fmt = w.format === 'currency' ? `'$' + data.${w.source}?.toLocaleString()`
            : w.format === 'percent' ? `data.${w.source} + '%'`
            : `data.${w.source}`;
        return `          <div className="rounded-lg border bg-card p-6 shadow-sm">
            <p className="text-sm text-muted-foreground">${w.label}</p>
            <p className="text-2xl font-bold">{${fmt}}</p>
          </div>`;
    });
    return `        <div className="grid grid-cols-${widgets.length || 3} gap-4">
${widgets.join('\n')}
        </div>`;
};

const generateChart = (section) => {
    const chart = section.chart || {};
    return `        {/* ${section.name}: ${chart.type || 'area'} chart — ${chart.xAxis} × ${chart.yAxis} */}
        <div className="rounded-lg border bg-card p-6 shadow-sm">
          <h3 className="text-lg font-semibold mb-4">${section.name}</h3>
          <div className="h-64 flex items-center justify-center text-muted-foreground">
            Chart: ${chart.type || 'area'} (${chart.xAxis} × ${chart.yAxis})
          </div>
        </div>`;
};

const generateDataTable = (section) => {
    const cols = (section.columns || []);
    const actions = (section.actions || []);
    const headerCells = cols.map((c) => `              <th className="px-4 py-3 text-left text-sm font-medium text-muted-foreground">${c}</th>`);
    if (actions.length) headerCells.push(`              <th className="px-4 py-3 text-right text-sm font-medium text-muted-foreground">Actions</th>`);
    const dataCells = cols.map((c) => `                <td className="px-4 py-3 text-sm">{row.${c}}</td>`);
    if (actions.length) {
        const btns = actions.map((a) => `<button className="text-sm text-primary hover:underline">${a}</button>`).join(' ');
        dataCells.push(`                <td className="px-4 py-3 text-sm text-right flex gap-2 justify-end">${btns}</td>`);
    }
    return `        <div className="rounded-lg border bg-card shadow-sm overflow-hidden">
          <h3 className="text-lg font-semibold p-6 pb-0">${section.name}</h3>
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="border-b">
                <tr>
${headerCells.join('\n')}
                </tr>
              </thead>
              <tbody>
                {data.${section.source || 'items'}?.map((row: any, i: number) => (
                  <tr key={i} className="border-b last:border-0">
${dataCells.join('\n')}
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>`;
};

const generateFormSection = (section) => {
    const fields = (section.fields || []).map((f) => {
        if (f.type === 'textarea') {
            return `          <div>
            <label className="block text-sm font-medium mb-1">${f.label}</label>
            <textarea className="w-full rounded-md border px-3 py-2" {...register('${f.name}'${f.required ? `, { required: true }` : ''})} />
          </div>`;
        }
        if (f.type === 'select') {
            const opts = (f.options || []).map((o) => `<option value="${o}">${o}</option>`).join('');
            return `          <div>
            <label className="block text-sm font-medium mb-1">${f.label}</label>
            <select className="w-full rounded-md border px-3 py-2" {...register('${f.name}'${f.required ? `, { required: true }` : ''})}>
              <option value="">Select...</option>${opts}
            </select>
          </div>`;
        }
        if (f.type === 'toggle') {
            return `          <div className="flex items-center gap-2">
            <input type="checkbox" {...register('${f.name}')} />
            <label className="text-sm font-medium">${f.label}</label>
          </div>`;
        }
        if (f.type === 'json') {
            return `          <div>
            <label className="block text-sm font-medium mb-1">${f.label}</label>
            <textarea className="w-full rounded-md border px-3 py-2 font-mono text-sm" rows={6} {...register('${f.name}'${f.required ? `, { required: true }` : ''})} />
          </div>`;
        }
        const inputType = f.type === 'number' ? 'number' : 'text';
        return `          <div>
            <label className="block text-sm font-medium mb-1">${f.label}</label>
            <input type="${inputType}" className="w-full rounded-md border px-3 py-2" {...register('${f.name}'${f.required ? `, { required: true }` : ''})} />
          </div>`;
    });
    return `        <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
${fields.join('\n')}
          <button type="submit" className="rounded-md bg-primary px-4 py-2 text-sm font-medium text-primary-foreground hover:bg-primary/90">
            Submit
          </button>
        </form>`;
};

const generateChatMessages = (_section) => {
    return `        <div className="flex-1 overflow-y-auto space-y-4 p-4">
          {messages.map((msg: any, i: number) => (
            <div key={i} className={\`flex \${msg.role === 'user' ? 'justify-end' : 'justify-start'}\`}>
              <div className={\`max-w-[80%] rounded-lg px-4 py-2 \${msg.role === 'user' ? 'bg-primary text-primary-foreground' : 'bg-muted'}\`}>
                {msg.content}
              </div>
            </div>
          ))}
          <div ref={messagesEndRef} />
        </div>`;
};

const generateChatInput = (_section) => {
    return `        <div className="border-t p-4">
          <form onSubmit={handleSend} className="flex gap-2">
            <input
              type="text"
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder="Type a message..."
              className="flex-1 rounded-md border px-3 py-2"
            />
            <button type="submit" className="rounded-md bg-primary px-4 py-2 text-sm font-medium text-primary-foreground">
              Send
            </button>
          </form>
        </div>`;
};

const generateCodeEditor = (section) => {
    return `        <div className="rounded-lg border bg-card shadow-sm overflow-hidden">
          <h3 className="text-sm font-medium p-3 border-b bg-muted">${section.name}</h3>
          <textarea className="w-full h-96 p-4 font-mono text-sm bg-background resize-none focus:outline-none" placeholder="// Code here..." />
        </div>`;
};

const generatePreview = (section) => {
    return `        <div className="rounded-lg border bg-card shadow-sm overflow-hidden">
          <h3 className="text-sm font-medium p-3 border-b bg-muted">${section.name}</h3>
          <div className="p-4 min-h-[24rem]">
            {/* Preview content */}
          </div>
        </div>`;
};

const generateCustom = (section) => {
    return `        <div className="rounded-lg border bg-card p-6 shadow-sm">
          <h3 className="text-lg font-semibold mb-4">${section.name}</h3>
          {/* Custom section — implement in your app */}
        </div>`;
};

const sectionRenderers = {
    'stat-cards': generateStatCards,
    'chart': generateChart,
    'data-table': generateDataTable,
    'form': generateFormSection,
    'chat-messages': generateChatMessages,
    'chat-input': generateChatInput,
    'code-editor': generateCodeEditor,
    'preview': generatePreview,
    'custom': generateCustom,
};

export const generateView = (view) => {
    const lines = [HEADER];
    const componentName = toPascalCase(view.name);
    const routeId = routeToId(view.route);

    // Determine needed imports
    const sectionTypes = new Set(view.sections.map((s) => s.type));
    const needsState = sectionTypes.has('chat-messages') || sectionTypes.has('chat-input');
    const needsRef = sectionTypes.has('chat-messages');
    const needsEffect = sectionTypes.has('chat-messages');
    const needsForm = sectionTypes.has('form');

    lines.push(`import { createFileRoute } from '@tanstack/react-router'`);

    const reactImports = [];
    if (needsState) reactImports.push('useState');
    if (needsRef) reactImports.push('useRef');
    if (needsEffect) reactImports.push('useEffect');
    if (reactImports.length) {
        lines.push(`import { ${reactImports.join(', ')} } from 'react'`);
    }

    lines.push('');
    lines.push(`export const Route = createFileRoute('${routeId}')({`);
    lines.push(`  component: ${componentName},`);
    lines.push(`})`);
    lines.push('');

    // Component
    lines.push(`function ${componentName}() {`);

    // State declarations
    if (needsState) {
        lines.push(`  const [messages, setMessages] = useState<any[]>([])`);
        lines.push(`  const [input, setInput] = useState('')`);
    }
    if (needsRef) {
        lines.push(`  const messagesEndRef = useRef<HTMLDivElement>(null)`);
    }
    if (needsEffect) {
        lines.push(`  useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }) }, [messages])`);
    }
    if (needsForm) {
        lines.push(`  const { register, handleSubmit } = useForm()`);
        lines.push(`  const onSubmit = (data: any) => console.log(data)`);
    }
    if (needsState) {
        lines.push(`  const handleSend = (e: React.FormEvent) => {`);
        lines.push(`    e.preventDefault()`);
        lines.push(`    if (!input.trim()) return`);
        lines.push(`    setMessages((prev) => [...prev, { role: 'user', content: input }])`);
        lines.push(`    setInput('')`);
        lines.push(`  }`);
    }

    // Loader data placeholder
    if (view.loader) {
        lines.push(`  const data: any = {} // TODO: wire to loader`);
    } else {
        lines.push(`  const data: any = {} // TODO: wire to data source`);
    }

    lines.push('');

    // Layout wrapper
    const layoutClass = view.layout === 'split' ? 'grid grid-cols-2 gap-6 p-6 h-screen'
        : view.layout === 'sidebar' ? 'flex h-screen'
        : view.layout === 'centered' ? 'max-w-2xl mx-auto p-6'
        : view.type === 'chat' ? 'flex flex-col h-screen'
        : 'flex flex-col gap-6 p-6';

    lines.push(`  return (`);
    lines.push(`    <div className="${layoutClass}">`);

    for (const section of view.sections) {
        const renderer = sectionRenderers[section.type] || generateCustom;
        lines.push(renderer(section));
    }

    lines.push(`    </div>`);
    lines.push(`  )`);
    lines.push(`}`);
    lines.push('');

    return lines.join('\n');
};
