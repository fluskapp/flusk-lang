// @generated by flusk-lang â€” DO NOT EDIT

import type { FastifyInstance, FastifyRequest, FastifyReply } from 'fastify';
import fp from 'fastify-plugin';

import bumpAgentConfig from '../functions/bumpAgentConfig.js';
import pushToAgents from '../functions/pushToAgents.js';
import agentRegister from '../functions/agentRegister.js';
import agentGetConfig from '../functions/agentGetConfig.js';
import agentReportError from '../functions/agentReportError.js';
import updateAgentConfig from '../functions/updateAgentConfig.js';
import getAgentLogs from '../functions/getAgentLogs.js';
import getAgentConfig from '../functions/getAgentConfig.js';

export default fp(async (app: FastifyInstance) => {

  // POST /api/v1/agent/register
  app.post('/api/v1/agent/register', {
    schema: {
      body: {
        type: 'object',
        properties: {
          deviceId: { type: 'string' },
          hostname: { type: 'string' },
          os: { type: 'string' },
          arch: { type: 'string' },
          agentVersion: { type: 'string' }
        },
        required: ['deviceId', 'hostname', 'os', 'arch', 'agentVersion'],
      },
    },
    onRequest: [app.authenticateApiKey],
  }, async (request: FastifyRequest, reply: FastifyReply) => {
    const input = request.body as Record<string, unknown>;
    Object.assign(input, { org_id: (request as any).orgId });
    return agentRegister(app, request, reply, input);
  });

  // GET /api/v1/agent/config
  app.get('/api/v1/agent/config', {
    onRequest: [app.authenticateApiKey],
  }, async (request: FastifyRequest, reply: FastifyReply) => {
    const input = {};
    Object.assign(input, { org_id: (request as any).orgId });
    return agentGetConfig(app, request, reply, input);
  });

  // POST /api/v1/agent/error
  app.post('/api/v1/agent/error', {
    schema: {
      body: {
        type: 'object',
        properties: {
          deviceId: { type: 'string' },
          errorType: { type: 'string' },
          message: { type: 'string' },
          stack: { type: 'string' }
        },
        required: ['deviceId', 'errorType', 'message'],
      },
    },
    onRequest: [app.authenticateApiKey],
  }, async (request: FastifyRequest, reply: FastifyReply) => {
    const input = request.body as Record<string, unknown>;
    Object.assign(input, { org_id: (request as any).orgId });
    return agentReportError(app, request, reply, input);
  });

  // PUT /api/org/agent-config
  app.put('/api/org/agent-config', {
    schema: {
      body: {
        type: 'object',
        properties: {
          heartbeatIntervalMs: { type: 'integer' },
          interceptPatterns: { type: 'array' }
        },
      },
    },
    onRequest: [app.authenticate],
  }, async (request: FastifyRequest, reply: FastifyReply) => {
    const input = request.body as Record<string, unknown>;
    const user = request.user as { sub: number; org: number; role: string };
    Object.assign(input, { org_id: user.org, user_id: user.sub });
    return updateAgentConfig(app, request, reply, input);
  });

  // GET /api/org/agent-logs
  app.get('/api/org/agent-logs', {
    onRequest: [app.authenticate],
  }, async (request: FastifyRequest, reply: FastifyReply) => {
    const input = {};
    const user = request.user as { sub: number; org: number; role: string };
    Object.assign(input, { org_id: user.org, user_id: user.sub });
    return getAgentLogs(app, request, reply, input);
  });

  // GET /api/org/agent-config
  app.get('/api/org/agent-config', {
    onRequest: [app.authenticate],
  }, async (request: FastifyRequest, reply: FastifyReply) => {
    const input = {};
    const user = request.user as { sub: number; org: number; role: string };
    Object.assign(input, { org_id: user.org, user_id: user.sub });
    return getAgentConfig(app, request, reply, input);
  });

});
