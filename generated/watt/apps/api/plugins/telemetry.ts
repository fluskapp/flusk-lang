// @generated by flusk-lang â€” DO NOT EDIT

import type { FastifyInstance, FastifyRequest, FastifyReply } from 'fastify';
import fp from 'fastify-plugin';

import processTelemetryBatch from '../functions/processTelemetryBatch.js';
import registerOrUpdateDevice from '../functions/registerOrUpdateDevice.js';
import setupDefaultTools from '../functions/setupDefaultTools.js';
import aggregateDailyUsage from '../functions/aggregateDailyUsage.js';
import ingestOtel from '../functions/ingestOtel.js';
import agentHeartbeat from '../functions/agentHeartbeat.js';
import getUsageSummary from '../functions/getUsageSummary.js';
import getUsageByProvider from '../functions/getUsageByProvider.js';
import getUsageByEmployee from '../functions/getUsageByEmployee.js';
import getShadowAi from '../functions/getShadowAi.js';
import getUsageTrends from '../functions/getUsageTrends.js';
import listDevices from '../functions/listDevices.js';
import revokeDevice from '../functions/revokeDevice.js';
import listTools from '../functions/listTools.js';
import approveTool from '../functions/approveTool.js';

export default fp(async (app: FastifyInstance) => {

  // POST /api/v1/telemetry/ingest
  app.post('/api/v1/telemetry/ingest', {
    onRequest: [app.authenticateApiKey],
  }, async (request: FastifyRequest, reply: FastifyReply) => {
    const input = {};
    Object.assign(input, { org_id: (request as any).orgId });
    return ingestOtel(app, request, reply, input);
  });

  // POST /api/v1/telemetry/heartbeat
  app.post('/api/v1/telemetry/heartbeat', {
    schema: {
      body: {
        type: 'object',
        properties: {
          deviceId: { type: 'string' },
          hostname: { type: 'string' },
          os: { type: 'string' },
          arch: { type: 'string' },
          agentVersion: { type: 'string' }
        },
        required: ['deviceId'],
      },
    },
    onRequest: [app.authenticateApiKey],
  }, async (request: FastifyRequest, reply: FastifyReply) => {
    const input = request.body as Record<string, unknown>;
    Object.assign(input, { org_id: (request as any).orgId });
    return agentHeartbeat(app, request, reply, input);
  });

  // GET /api/dashboard/usage
  app.get('/api/dashboard/usage', {
    onRequest: [app.authenticate],
  }, async (request: FastifyRequest, reply: FastifyReply) => {
    const input = {};
    const user = request.user as { sub: number; org: number; role: string };
    Object.assign(input, { org_id: user.org, user_id: user.sub });
    return getUsageSummary(app, request, reply, input);
  });

  // GET /api/dashboard/usage/providers
  app.get('/api/dashboard/usage/providers', {
    onRequest: [app.authenticate],
  }, async (request: FastifyRequest, reply: FastifyReply) => {
    const input = {};
    const user = request.user as { sub: number; org: number; role: string };
    Object.assign(input, { org_id: user.org, user_id: user.sub });
    return getUsageByProvider(app, request, reply, input);
  });

  // GET /api/dashboard/usage/employees
  app.get('/api/dashboard/usage/employees', {
    onRequest: [app.authenticate],
  }, async (request: FastifyRequest, reply: FastifyReply) => {
    const input = {};
    const user = request.user as { sub: number; org: number; role: string };
    Object.assign(input, { org_id: user.org, user_id: user.sub });
    return getUsageByEmployee(app, request, reply, input);
  });

  // GET /api/dashboard/shadow-ai
  app.get('/api/dashboard/shadow-ai', {
    onRequest: [app.authenticate],
  }, async (request: FastifyRequest, reply: FastifyReply) => {
    const input = {};
    const user = request.user as { sub: number; org: number; role: string };
    Object.assign(input, { org_id: user.org, user_id: user.sub });
    return getShadowAi(app, request, reply, input);
  });

  // GET /api/dashboard/trends
  app.get('/api/dashboard/trends', {
    onRequest: [app.authenticate],
  }, async (request: FastifyRequest, reply: FastifyReply) => {
    const input = {};
    const user = request.user as { sub: number; org: number; role: string };
    Object.assign(input, { org_id: user.org, user_id: user.sub });
    return getUsageTrends(app, request, reply, input);
  });

  // GET /api/devices
  app.get('/api/devices', {
    onRequest: [app.authenticate],
  }, async (request: FastifyRequest, reply: FastifyReply) => {
    const input = {};
    const user = request.user as { sub: number; org: number; role: string };
    Object.assign(input, { org_id: user.org, user_id: user.sub });
    return listDevices(app, request, reply, input);
  });

  // DELETE /api/devices/:deviceId
  app.delete('/api/devices/:deviceId', {
    onRequest: [app.authenticate],
  }, async (request: FastifyRequest, reply: FastifyReply) => {
    const input = {};
    const params = request.params as Record<string, string>;
    Object.assign(input, params);
    const user = request.user as { sub: number; org: number; role: string };
    Object.assign(input, { org_id: user.org, user_id: user.sub });
    return revokeDevice(app, request, reply, input);
  });

  // GET /api/tools
  app.get('/api/tools', {
    onRequest: [app.authenticate],
  }, async (request: FastifyRequest, reply: FastifyReply) => {
    const input = {};
    const user = request.user as { sub: number; org: number; role: string };
    Object.assign(input, { org_id: user.org, user_id: user.sub });
    return listTools(app, request, reply, input);
  });

  // PATCH /api/tools/:toolId
  app.patch('/api/tools/:toolId', {
    schema: {
      body: {
        type: 'object',
        properties: {
          approved: { type: 'boolean' }
        },
        required: ['approved'],
      },
    },
    onRequest: [app.authenticate],
  }, async (request: FastifyRequest, reply: FastifyReply) => {
    const input = request.body as Record<string, unknown>;
    const params = request.params as Record<string, string>;
    Object.assign(input, params);
    const user = request.user as { sub: number; org: number; role: string };
    Object.assign(input, { org_id: user.org, user_id: user.sub });
    return approveTool(app, request, reply, input);
  });

});
