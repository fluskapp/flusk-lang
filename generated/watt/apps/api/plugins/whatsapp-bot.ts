// @generated by flusk-lang â€” DO NOT EDIT

import type { FastifyInstance, FastifyRequest, FastifyReply } from 'fastify';
import fp from 'fastify-plugin';

import generateAiReply from '../functions/generateAiReply.js';
import sendWhatsappMessage from '../functions/sendWhatsappMessage.js';
import webhookIncoming from '../functions/webhookIncoming.js';
import webhookVerify from '../functions/webhookVerify.js';
import createBot from '../functions/createBot.js';
import updateBot from '../functions/updateBot.js';
import listBots from '../functions/listBots.js';
import getBotStats from '../functions/getBotStats.js';
import listConversations from '../functions/listConversations.js';
import getConversationMessages from '../functions/getConversationMessages.js';

export default fp(async (app: FastifyInstance) => {

  // POST /webhooks/whatsapp/:botId
  app.post('/webhooks/whatsapp/:botId', {
    schema: {
      body: {
        type: 'object',
        properties: {
          message: { type: 'object' }
        },
        required: ['message'],
      },
    },
  }, async (request: FastifyRequest, reply: FastifyReply) => {
    const input = request.body as Record<string, unknown>;
    const params = request.params as Record<string, string>;
    Object.assign(input, params);
    return webhookIncoming(app, request, reply, input);
  });

  // GET /webhooks/whatsapp/:botId
  app.get('/webhooks/whatsapp/:botId', {
  }, async (request: FastifyRequest, reply: FastifyReply) => {
    const input = request.query as Record<string, unknown>;
    const params = request.params as Record<string, string>;
    Object.assign(input, params);
    return webhookVerify(app, request, reply, input);
  });

  // POST /api/bots
  app.post('/api/bots', {
    schema: {
      body: {
        type: 'object',
        properties: {
          name: { type: 'string' },
          phoneNumber: { type: 'string' },
          systemPrompt: { type: 'string' },
          model: { type: 'string' }
        },
        required: ['name', 'phoneNumber', 'systemPrompt'],
      },
    },
    onRequest: [app.authenticate],
  }, async (request: FastifyRequest, reply: FastifyReply) => {
    const input = request.body as Record<string, unknown>;
    const user = request.user as { sub: number; org: number; role: string };
    Object.assign(input, { org_id: user.org, user_id: user.sub });
    return createBot(app, request, reply, input);
  });

  // PUT /api/bots/:id
  app.put('/api/bots/:id', {
    schema: {
      body: {
        type: 'object',
        properties: {
          name: { type: 'string' },
          systemPrompt: { type: 'string' },
          model: { type: 'string' },
          active: { type: 'boolean' }
        },
      },
    },
    onRequest: [app.authenticate],
  }, async (request: FastifyRequest, reply: FastifyReply) => {
    const input = request.body as Record<string, unknown>;
    const params = request.params as Record<string, string>;
    Object.assign(input, params);
    const user = request.user as { sub: number; org: number; role: string };
    Object.assign(input, { org_id: user.org, user_id: user.sub });
    return updateBot(app, request, reply, input);
  });

  // GET /api/bots
  app.get('/api/bots', {
    onRequest: [app.authenticate],
  }, async (request: FastifyRequest, reply: FastifyReply) => {
    const input = {};
    const user = request.user as { sub: number; org: number; role: string };
    Object.assign(input, { org_id: user.org, user_id: user.sub });
    return listBots(app, request, reply, input);
  });

  // GET /api/bots/:id/stats
  app.get('/api/bots/:id/stats', {
    onRequest: [app.authenticate],
  }, async (request: FastifyRequest, reply: FastifyReply) => {
    const input = {};
    const params = request.params as Record<string, string>;
    Object.assign(input, params);
    const user = request.user as { sub: number; org: number; role: string };
    Object.assign(input, { org_id: user.org, user_id: user.sub });
    return getBotStats(app, request, reply, input);
  });

  // GET /api/bots/:id/conversations
  app.get('/api/bots/:id/conversations', {
    onRequest: [app.authenticate],
  }, async (request: FastifyRequest, reply: FastifyReply) => {
    const input = {};
    const params = request.params as Record<string, string>;
    Object.assign(input, params);
    const user = request.user as { sub: number; org: number; role: string };
    Object.assign(input, { org_id: user.org, user_id: user.sub });
    return listConversations(app, request, reply, input);
  });

  // GET /api/bots/:id/conversations/:conversationId/messages
  app.get('/api/bots/:id/conversations/:conversationId/messages', {
    onRequest: [app.authenticate],
  }, async (request: FastifyRequest, reply: FastifyReply) => {
    const input = {};
    const params = request.params as Record<string, string>;
    Object.assign(input, params);
    const user = request.user as { sub: number; org: number; role: string };
    Object.assign(input, { org_id: user.org, user_id: user.sub });
    return getConversationMessages(app, request, reply, input);
  });

});
