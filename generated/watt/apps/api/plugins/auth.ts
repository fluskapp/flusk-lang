// @generated by flusk-lang â€” DO NOT EDIT

import type { FastifyInstance, FastifyRequest, FastifyReply } from 'fastify';
import fp from 'fastify-plugin';
import fjwt from '@fastify/jwt';

export default fp(async (app: FastifyInstance) => {

  // Register JWT plugin
  await app.register(fjwt, {
    secret: process.env.JWT_SECRET || 'dev-secret',
  });

  // JWT auth decorator
  app.decorate("authenticate", async (request: FastifyRequest, reply: FastifyReply) => {
    try {
      await request.jwtVerify();
    } catch (err) {
      return reply.code(401).send({ error: 'Unauthorized' });
    }
  });

  // API key auth decorator (for desktop agents)
  app.decorate("authenticateApiKey", async (request: FastifyRequest, reply: FastifyReply) => {
    const apiKey = request.headers['x-api-key'] as string;
    if (!apiKey) {
      return reply.code(401).send({ error: 'API key required' });
    }
    const org = await app.platformatic.entities.organization.find({
      where: { apiKey: { eq: apiKey } },
      limit: 1,
    });
    if (!org || org.length === 0) {
      return reply.code(401).send({ error: 'Invalid API key' });
    }
    (request as any).orgId = org[0].id;
  });

  // Health check
  app.get('/status', async () => ({ status: 'ok', timestamp: new Date().toISOString() }));

});
