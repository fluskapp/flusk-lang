// @generated by flusk-lang â€” DO NOT EDIT

import type { FastifyInstance, FastifyRequest, FastifyReply } from 'fastify';
import fp from 'fastify-plugin';

import verifyCredentials from '../functions/verifyCredentials.js';
import processInvite from '../functions/processInvite.js';
import generateApiKey from '../functions/generateApiKey.js';
import registerOrgHandler from '../functions/registerOrgHandler.js';
import registerOrg from '../functions/registerOrg.js';
import login from '../functions/login.js';
import inviteMember from '../functions/inviteMember.js';
import acceptInvite from '../functions/acceptInvite.js';
import getOrg from '../functions/getOrg.js';
import listMembers from '../functions/listMembers.js';
import updateMemberRole from '../functions/updateMemberRole.js';
import rotateApiKey from '../functions/rotateApiKey.js';

export default fp(async (app: FastifyInstance) => {

  // POST /api/auth/register
  app.post('/api/auth/register', {
    schema: {
      body: {
        type: 'object',
        properties: {
          orgName: { type: 'string' },
          email: { type: 'string' },
          password: { type: 'string' },
          name: { type: 'string' }
        },
        required: ['orgName', 'email', 'password', 'name'],
      },
    },
  }, async (request: FastifyRequest, reply: FastifyReply) => {
    const input = request.body as Record<string, unknown>;
    return registerOrg(app, request, reply, input);
  });

  // POST /api/auth/login
  app.post('/api/auth/login', {
    schema: {
      body: {
        type: 'object',
        properties: {
          email: { type: 'string' },
          password: { type: 'string' }
        },
        required: ['email', 'password'],
      },
    },
  }, async (request: FastifyRequest, reply: FastifyReply) => {
    const input = request.body as Record<string, unknown>;
    return login(app, request, reply, input);
  });

  // POST /api/org/invite
  app.post('/api/org/invite', {
    schema: {
      body: {
        type: 'object',
        properties: {
          email: { type: 'string' },
          role: { type: 'string' }
        },
        required: ['email'],
      },
    },
    onRequest: [app.authenticate],
  }, async (request: FastifyRequest, reply: FastifyReply) => {
    const input = request.body as Record<string, unknown>;
    const user = request.user as { sub: number; org: number; role: string };
    Object.assign(input, { org_id: user.org, user_id: user.sub });
    return inviteMember(app, request, reply, input);
  });

  // POST /api/auth/accept-invite
  app.post('/api/auth/accept-invite', {
    schema: {
      body: {
        type: 'object',
        properties: {
          token: { type: 'string' },
          name: { type: 'string' },
          password: { type: 'string' }
        },
        required: ['token', 'name', 'password'],
      },
    },
  }, async (request: FastifyRequest, reply: FastifyReply) => {
    const input = request.body as Record<string, unknown>;
    return acceptInvite(app, request, reply, input);
  });

  // GET /api/org
  app.get('/api/org', {
    onRequest: [app.authenticate],
  }, async (request: FastifyRequest, reply: FastifyReply) => {
    const input = {};
    const user = request.user as { sub: number; org: number; role: string };
    Object.assign(input, { org_id: user.org, user_id: user.sub });
    return getOrg(app, request, reply, input);
  });

  // GET /api/org/members
  app.get('/api/org/members', {
    onRequest: [app.authenticate],
  }, async (request: FastifyRequest, reply: FastifyReply) => {
    const input = {};
    const user = request.user as { sub: number; org: number; role: string };
    Object.assign(input, { org_id: user.org, user_id: user.sub });
    return listMembers(app, request, reply, input);
  });

  // PATCH /api/org/members/:memberId
  app.patch('/api/org/members/:memberId', {
    schema: {
      body: {
        type: 'object',
        properties: {
          role: { type: 'string' }
        },
        required: ['role'],
      },
    },
    onRequest: [app.authenticate],
  }, async (request: FastifyRequest, reply: FastifyReply) => {
    const input = request.body as Record<string, unknown>;
    const params = request.params as Record<string, string>;
    Object.assign(input, params);
    const user = request.user as { sub: number; org: number; role: string };
    Object.assign(input, { org_id: user.org, user_id: user.sub });
    return updateMemberRole(app, request, reply, input);
  });

  // POST /api/org/rotate-key
  app.post('/api/org/rotate-key', {
    onRequest: [app.authenticate],
  }, async (request: FastifyRequest, reply: FastifyReply) => {
    const input = {};
    const user = request.user as { sub: number; org: number; role: string };
    Object.assign(input, { org_id: user.org, user_id: user.sub });
    return rotateApiKey(app, request, reply, input);
  });

});
