// @generated by flusk-lang logic compiler
import type { FastifyInstance, FastifyRequest, FastifyReply } from 'fastify';

interface TeardownDeploymentInput {
  deploymentId: number;
}

export default async function teardownDeployment(
  app: FastifyInstance,
  request: FastifyRequest,
  reply: FastifyReply,
  input: TeardownDeploymentInput,
) {
  const deployment = await app.platformatic.entities.deployment.find({ where: { id: input.deployment_id }, limit: 1 }).then(r => r[0] ?? null);
  if (!(deployment)) {
    return reply.code(404).send({ error: 'Deployment not found' });
  }
  const _ = http.delete(openclaw-api.deleteGateway, { id: deployment.instance_id });
  await app.platformatic.entities.deployment.save({ input: { id: deployment.id, status: 'removed' } });
  const active = await app.platformatic.entities.deployment.find({ where: { solution_id: deployment.solution_id, status: 'active' } });
  if ((active.length == 0)) {
    await app.platformatic.entities.solution.save({ input: { id: deployment.solution_id, status: 'draft' } });
  }
  return reply.send({ success: true });
}
