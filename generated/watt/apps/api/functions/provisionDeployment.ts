// @generated by flusk-lang logic compiler
import type { FastifyInstance, FastifyRequest, FastifyReply } from 'fastify';

import { randomUUID, createHash } from 'node:crypto';
// now() = new Date().toISOString()

interface ProvisionDeploymentInput {
  solutionId: number;
  channel: string;
  channelConfig: Record<string, unknown>;
}

export default async function provisionDeployment(
  app: FastifyInstance,
  request: FastifyRequest,
  reply: FastifyReply,
  input: ProvisionDeploymentInput,
) {
  const solution = await app.platformatic.entities.solution.find({ where: { id: input.solution_id }, limit: 1 }).then(r => r[0] ?? null);
  if (!(solution)) {
    return reply.code(404).send({ error: 'Solution not found' });
  }
  const instance_id = randomUUID();
  if ((input.channel == 'slack')) {
    const endpoint = http.post(openclaw-api.createGateway, { name: solution.name, llm_provider: solution.llm_provider, llm_model: solution.llm_model, system_prompt: solution.system_prompt, channel: 'slack', channel_config: input.channel_config });
  }
  if ((input.channel == 'whatsapp')) {
    const endpoint = http.post(openclaw-api.createGateway, { name: solution.name, llm_provider: solution.llm_provider, llm_model: solution.llm_model, system_prompt: solution.system_prompt, channel: 'whatsapp', channel_config: input.channel_config });
  }
  const deployment = await app.platformatic.entities.deployment.save({ input: { solution_id: input.solution_id, org_id: solution.org_id, channel: input.channel, channel_config: input.channel_config, status: 'active', instance_id, health_status: 'healthy', last_health_check: new Date().toISOString() } });
  await app.platformatic.entities.solution.save({ input: { id: solution.id, status: 'published', published_at: new Date().toISOString() } });
  return reply.send({ instance_id, endpoint });
}
