// @generated by flusk-lang logic compiler
import type { FastifyInstance, FastifyRequest, FastifyReply } from 'fastify';

interface BumpAgentConfigInput {
  orgId: number;
  changes: Record<string, unknown>;
}

export default async function bumpAgentConfig(
  app: FastifyInstance,
  request: FastifyRequest,
  reply: FastifyReply,
  input: BumpAgentConfigInput,
) {
  const current = await app.platformatic.entities.agentConfig.find({ where: { org_id: input.org_id }, limit: 1 }).then(r => r[0] ?? null);
  const new_version = current ? current.version + 1 : 1;
  const approved_tools = await app.platformatic.entities.aiTool.find({ where: { org_id: input.org_id, approved: true } });
  const solutions = await app.platformatic.entities.deployment.find({ where: { org_id: input.org_id, status: 'active' } });
  const config = await app.platformatic.entities.agentConfig.save({ input: { org_id: input.org_id, version: new_version, otel_endpoint: '/api/v1/telemetry/ingest', heartbeat_interval_ms: (input.changes.heartbeat_interval_ms ?? 60000), approved_tools, intercept_patterns: (input.changes.intercept_patterns ?? ['api.openai.com', 'api.anthropic.com', 'generativelanguage.googleapis.com', 'api.cursor.sh']), solutions } });
  return reply.send(config);
}
