// @generated by flusk-lang logic compiler
import type { FastifyInstance, FastifyRequest, FastifyReply } from 'fastify';

const slugify = (s: string) => s.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
import bcrypt from 'bcrypt';
import { nanoid } from 'nanoid';
// JWT handled via app.jwt (fastify-jwt plugin)

interface RegisterOrgHandlerInput {
  orgName: string;
  email: string;
  password: string;
  name: string;
}

export default async function registerOrgHandler(
  app: FastifyInstance,
  request: FastifyRequest,
  reply: FastifyReply,
  input: RegisterOrgHandlerInput,
) {
  const slug = slugify(input.org_name);
  const existing = await app.platformatic.entities.organization.find({ where: { slug }, limit: 1 }).then(r => r[0] ?? null);
  if (!(!(existing))) {
    return reply.code(409).send({ error: 'Organization already exists' });
  }
  const password_hash = await bcrypt.hash(input.password, 10);
  const api_key = nanoid(32);
  const org = await app.platformatic.entities.organization.save({ input: { name: input.org_name, slug, api_key, status: trial } });
  const member = await app.platformatic.entities.orgMember.save({ input: { org_id: org.id, email: input.email, name: input.name, password_hash, role: owner, status: active } });
  const token = app.jwt.sign({ sub: member.id, org: org.id, role: owner });
  app.emit('orgCreated', { org_id: org.id, name: org.name });
  return reply.send({ token, org, member });
}
