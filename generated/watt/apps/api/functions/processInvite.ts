// @generated by flusk-lang logic compiler
import type { FastifyInstance, FastifyRequest, FastifyReply } from 'fastify';

import bcrypt from 'bcrypt';
// JWT handled via app.jwt (fastify-jwt plugin)

interface ProcessInviteInput {
  token: string;
  name: string;
  password: string;
}

export default async function processInvite(
  app: FastifyInstance,
  request: FastifyRequest,
  reply: FastifyReply,
  input: ProcessInviteInput,
) {
  const invite = await app.platformatic.entities.invite.find({ where: { token: input.token }, limit: 1 }).then(r => r[0] ?? null);
  if (!(invite)) {
    return reply.code(404).send({ error: 'Invite not found' });
  }
  if (!(!(invite.accepted))) {
    return reply.code(409).send({ error: 'Invite already used' });
  }
  const password_hash = await bcrypt.hash(input.password, 10);
  const member = await app.platformatic.entities.orgMember.save({ input: { org_id: invite.org_id, email: invite.email, name: input.name, password_hash, role: invite.role, status: active } });
  const org = await app.platformatic.entities.organization.find({ where: { id: invite.org_id }, limit: 1 }).then(r => r[0] ?? null);
  const token = app.jwt.sign({ sub: member.id, org: org.id, role: member.role });
  return reply.send({ token, member, org });
}
