// @generated by flusk-lang logic compiler
import type { FastifyInstance, FastifyRequest, FastifyReply } from 'fastify';

interface SendAlertNotificationInput {
  alertId: number;
  channels: unknown[];
}

export default async function sendAlertNotification(
  app: FastifyInstance,
  request: FastifyRequest,
  reply: FastifyReply,
  input: SendAlertNotificationInput,
) {
  const alert = await app.platformatic.entities.alert.find({ where: { id: input.alert_id }, limit: 1 }).then(r => r[0] ?? null);
  if (!(alert)) {
    return reply.code(404).send({ error: 'Alert not found' });
  }
  const results = [];
  for (const channel of input.channels) {
    if ((channel.type == 'email')) {
      const _ = http.post(channel.webhook_url, { subject: alert.title, body: alert.message });
    }
    if ((channel.type == 'slack')) {
      const _ = http.post(channel.webhook_url, { text: alert.title + ': ' + alert.message });
    }
    if ((channel.type == 'webhook')) {
      const _ = http.post(channel.webhook_url, { alert_id: alert.id, type: alert.type, severity: alert.severity, title: alert.title, message: alert.message });
    }
  }
}
