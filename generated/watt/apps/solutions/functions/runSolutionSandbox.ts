// @generated by flusk-lang logic compiler
import type { FastifyInstance, FastifyRequest, FastifyReply } from 'fastify';

interface RunSolutionSandboxInput {
  solutionId: number;
  message: string;
}

export default async function runSolutionSandbox(
  app: FastifyInstance,
  request: FastifyRequest,
  reply: FastifyReply,
  input: RunSolutionSandboxInput,
) {
  const solution = await app.platformatic.entities.solution.find({ where: { id: input.solution_id }, limit: 1 }).then(r => r[0] ?? null);
  if (!(solution)) {
    return reply.code(404).send({ error: 'Solution not found' });
  }
  const start = Date.now();
  const result = http.post(solution.llm_provider + '/chat/completions', { model: solution.llm_model, messages: [{ role: 'system', content: solution.system_prompt }, { role: 'user', content: input.message }], temperature: solution.temperature, max_tokens: solution.max_tokens });
  const latency_ms = Date.now() - start;
  const tokens_used = (result.usage.total_tokens ?? 0);
  return reply.send({ response: result.choices[0].message.content, tokens_used, latency_ms });
}
