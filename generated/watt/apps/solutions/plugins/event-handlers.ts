// @generated by flusk-lang â€” DO NOT EDIT

import { type FastifyInstance } from 'fastify';
import fp from 'fastify-plugin';
import { SOLUTION_CREATED, SOLUTION_PUBLISHED, KNOWLEDGE_UPLOADED, SolutionCreatedPayload, SolutionPublishedPayload, KnowledgeUploadedPayload } from './event-bus.js';

import { notifyAgentsNewSolution } from '../workers/notifyAgentsNewSolution.js';
import { processKnowledgeBase } from '../workers/processKnowledgeBase.js';

export default fp(async (app: FastifyInstance) => {

  // solution-created
  app.events.on(SOLUTION_CREATED, async (payload: SolutionCreatedPayload) => {
    app.log.info({ event: SOLUTION_CREATED, payload }, 'Event received');
  });

  // solution-published
  app.events.on(SOLUTION_PUBLISHED, async (payload: SolutionPublishedPayload) => {
    app.log.info({ event: SOLUTION_PUBLISHED, payload }, 'Event received');
    try {
      await notifyAgentsNewSolution(app.platformatic, payload);
    } catch (err) {
      app.log.error({ err, worker: 'notify-agents-new-solution' }, 'Worker failed');
    }
  });

  // knowledge-uploaded
  app.events.on(KNOWLEDGE_UPLOADED, async (payload: KnowledgeUploadedPayload) => {
    app.log.info({ event: KNOWLEDGE_UPLOADED, payload }, 'Event received');
    try {
      await processKnowledgeBase(app.platformatic, payload);
    } catch (err) {
      app.log.error({ err, worker: 'process-knowledge-base' }, 'Worker failed');
    }
  });
});
