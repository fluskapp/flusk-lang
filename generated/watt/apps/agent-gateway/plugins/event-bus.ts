// @generated by flusk-lang â€” DO NOT EDIT

import { EventEmitter } from 'node:events';
import { type FastifyInstance } from 'fastify';
import fp from 'fastify-plugin';

export const AGENT_CONNECTED = 'agent-connected';
export const CONFIG_UPDATED = 'config-updated';

export interface AgentConnectedPayload {
  org_id: string;
  device_id: string;
}

export interface ConfigUpdatedPayload {
  org_id: string;
  version: string;
}

export interface FluskEvents {
  'agent-connected': AgentConnectedPayload;
  'config-updated': ConfigUpdatedPayload;
}

export class FluskEventBus {
  private emitter = new EventEmitter();

  emit<K extends keyof FluskEvents>(event: K, payload: FluskEvents[K]): void {
    this.emitter.emit(event, payload);
  }

  on<K extends keyof FluskEvents>(event: K, handler: (payload: FluskEvents[K]) => void | Promise<void>): void {
    this.emitter.on(event, handler);
  }

  off<K extends keyof FluskEvents>(event: K, handler: (payload: FluskEvents[K]) => void | Promise<void>): void {
    this.emitter.off(event, handler);
  }
}

declare module 'fastify' {
  interface FastifyInstance {
    events: FluskEventBus;
  }
}

export default fp(async (app: FastifyInstance) => {
  const bus = new FluskEventBus();
  app.decorate('events', bus);
  app.log.info('Event bus registered');
});
