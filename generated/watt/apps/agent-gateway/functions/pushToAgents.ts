// @generated by flusk-lang logic compiler
import type { FastifyInstance, FastifyRequest, FastifyReply } from 'fastify';

interface PushToAgentsInput {
  orgId: number;
  payload: Record<string, unknown>;
}

export default async function pushToAgents(
  app: FastifyInstance,
  request: FastifyRequest,
  reply: FastifyReply,
  input: PushToAgentsInput,
) {
  const devices = await app.platformatic.entities.agentDevice.find({ where: { org_id: input.org_id, status: 'active' } });
  const results = [];
  for (const device of devices) {
    await app.platformatic.entities.agentEventLog.save({ input: { org_id: input.org_id, device_id: device.device_id, event_type: 'config-updated', details: input.payload } });
  }
  return reply.send({ notified: devices.length });
}
