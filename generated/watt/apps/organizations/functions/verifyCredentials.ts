// @generated by flusk-lang logic compiler
import type { FastifyInstance, FastifyRequest, FastifyReply } from 'fastify';

import bcrypt from 'bcrypt';
// JWT handled via app.jwt (fastify-jwt plugin)

interface VerifyCredentialsInput {
  email: string;
  password: string;
}

export default async function verifyCredentials(
  app: FastifyInstance,
  request: FastifyRequest,
  reply: FastifyReply,
  input: VerifyCredentialsInput,
) {
  const member = await app.platformatic.entities.orgMember.find({ where: { email: input.email }, limit: 1 }).then(r => r[0] ?? null);
  if (!(member)) {
    return reply.code(401).send({ error: 'Invalid credentials' });
  }
  const valid = await bcrypt.compare(input.password, member.password_hash);
  if (!(valid)) {
    return reply.code(401).send({ error: 'Invalid credentials' });
  }
  const org = await app.platformatic.entities.organization.find({ where: { id: member.org_id }, limit: 1 }).then(r => r[0] ?? null);
  const token = app.jwt.sign({ sub: member.id, org: org.id, role: member.role });
  return reply.send({ token, member, org });
}
