// @generated by flusk-lang logic compiler
import type { FastifyInstance, FastifyRequest, FastifyReply } from 'fastify';

interface SendWhatsappMessageInput {
  phone: string;
  message: string;
  botId: string;
}

export default async function sendWhatsappMessage(
  app: FastifyInstance,
  request: FastifyRequest,
  reply: FastifyReply,
  input: SendWhatsappMessageInput,
) {
  const bot = await app.platformatic.entities.bot.find({ where: { id: input.bot_id }, limit: 1 }).then(r => r[0] ?? null);
  if (!(bot)) {
    return reply.code(404).send({ error: 'Bot not found' });
  }
  const config = await app.platformatic.entities.webhookConfig.find({ where: { bot_id: input.bot_id }, limit: 1 }).then(r => r[0] ?? null);
  const result = http.post(config.provider_url + '/api/sendText', { chatId: input.phone, text: input.message });
  return reply.send({ sent: true, message_id: result.id });
}
