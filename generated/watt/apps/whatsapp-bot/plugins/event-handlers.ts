// @generated by flusk-lang â€” DO NOT EDIT

import { type FastifyInstance } from 'fastify';
import fp from 'fastify-plugin';
import { MESSAGE_RECEIVED, BOT_CREATED, MessageReceivedPayload, BotCreatedPayload } from './event-bus.js';

import { processIncomingMessage } from '../workers/processIncomingMessage.js';
import { setupWebhook } from '../workers/setupWebhook.js';

export default fp(async (app: FastifyInstance) => {

  // message-received
  app.events.on(MESSAGE_RECEIVED, async (payload: MessageReceivedPayload) => {
    app.log.info({ event: MESSAGE_RECEIVED, payload }, 'Event received');
    try {
      await processIncomingMessage(app.platformatic, payload);
    } catch (err) {
      app.log.error({ err, worker: 'process-incoming-message' }, 'Worker failed');
    }
  });

  // bot-created
  app.events.on(BOT_CREATED, async (payload: BotCreatedPayload) => {
    app.log.info({ event: BOT_CREATED, payload }, 'Event received');
    try {
      await setupWebhook(app.platformatic, payload);
    } catch (err) {
      app.log.error({ err, worker: 'setup-webhook' }, 'Worker failed');
    }
  });
});
