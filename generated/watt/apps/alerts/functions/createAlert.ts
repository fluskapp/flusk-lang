// @generated by flusk-lang logic compiler
import type { FastifyInstance, FastifyRequest, FastifyReply } from 'fastify';

interface CreateAlertInput {
  orgId: number;
  type: string;
  title: string;
  message: string;
  context: Record<string, unknown>;
}

export default async function createAlert(
  app: FastifyInstance,
  request: FastifyRequest,
  reply: FastifyReply,
  input: CreateAlertInput,
) {
  const rules = await app.platformatic.entities.alertRule.find({ where: { org_id: input.org_id, type: input.type, enabled: true } });
  const severity = 'medium';
  if ((input.type == 'shadow-ai')) {
    const severity = 'high';
  }
  if ((input.type == 'budget-exceeded')) {
    const severity = 'critical';
  }
  const alert = await app.platformatic.entities.alert.save({ input: { org_id: input.org_id, type: input.type, severity, title: input.title, message: input.message, context: input.context, status: 'open' } });
  if ((rules.length > 0)) {
    await app.platformatic.entities.alert.save({ input: { id: alert.id, rule_id: rules[0].id } });
    app.emit('alertTriggered', { org_id: input.org_id, alert_id: alert.id, type: input.type, severity: severity });
  }
  return reply.send(alert);
}
