// @generated by flusk-lang â€” DO NOT EDIT

import { EventEmitter } from 'node:events';
import { type FastifyInstance } from 'fastify';
import fp from 'fastify-plugin';

export const TELEMETRY_RECEIVED = 'telemetry-received';
export const SHADOW_AI_DETECTED = 'shadow-ai-detected';
export const NEW_TOOL_DETECTED = 'new-tool-detected';

export interface TelemetryReceivedPayload {
  org_id: string;
  device_id: string;
  event_count: string;
}

export interface ShadowAiDetectedPayload {
  org_id: string;
  device_id: string;
  tool_name: string;
  provider: string;
}

export interface NewToolDetectedPayload {
  org_id: string;
  tool_name: string;
  provider: string;
}

export interface FluskEvents {
  'telemetry-received': TelemetryReceivedPayload;
  'shadow-ai-detected': ShadowAiDetectedPayload;
  'new-tool-detected': NewToolDetectedPayload;
}

export class FluskEventBus {
  private emitter = new EventEmitter();

  emit<K extends keyof FluskEvents>(event: K, payload: FluskEvents[K]): void {
    this.emitter.emit(event, payload);
  }

  on<K extends keyof FluskEvents>(event: K, handler: (payload: FluskEvents[K]) => void | Promise<void>): void {
    this.emitter.on(event, handler);
  }

  off<K extends keyof FluskEvents>(event: K, handler: (payload: FluskEvents[K]) => void | Promise<void>): void {
    this.emitter.off(event, handler);
  }
}

declare module 'fastify' {
  interface FastifyInstance {
    events: FluskEventBus;
  }
}

export default fp(async (app: FastifyInstance) => {
  const bus = new FluskEventBus();
  app.decorate('events', bus);
  app.log.info('Event bus registered');
});
