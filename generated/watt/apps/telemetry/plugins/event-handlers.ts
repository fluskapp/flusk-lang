// @generated by flusk-lang â€” DO NOT EDIT

import { type FastifyInstance } from 'fastify';
import fp from 'fastify-plugin';
import { TELEMETRY_RECEIVED, SHADOW_AI_DETECTED, NEW_TOOL_DETECTED, TelemetryReceivedPayload, ShadowAiDetectedPayload, NewToolDetectedPayload } from './event-bus.js';

import { detectAnomalies } from '../workers/detectAnomalies.js';
import { updateDailyAggregates } from '../workers/updateDailyAggregates.js';
import { createShadowAlert } from '../workers/createShadowAlert.js';

export default fp(async (app: FastifyInstance) => {

  // telemetry-received
  app.events.on(TELEMETRY_RECEIVED, async (payload: TelemetryReceivedPayload) => {
    app.log.info({ event: TELEMETRY_RECEIVED, payload }, 'Event received');
    try {
      await detectAnomalies(app.platformatic, payload);
    } catch (err) {
      app.log.error({ err, worker: 'detect-anomalies' }, 'Worker failed');
    }
    try {
      await updateDailyAggregates(app.platformatic, payload);
    } catch (err) {
      app.log.error({ err, worker: 'update-daily-aggregates' }, 'Worker failed');
    }
  });

  // shadow-ai-detected
  app.events.on(SHADOW_AI_DETECTED, async (payload: ShadowAiDetectedPayload) => {
    app.log.info({ event: SHADOW_AI_DETECTED, payload }, 'Event received');
    try {
      await createShadowAlert(app.platformatic, payload);
    } catch (err) {
      app.log.error({ err, worker: 'create-shadow-alert' }, 'Worker failed');
    }
  });

  // new-tool-detected
  app.events.on(NEW_TOOL_DETECTED, async (payload: NewToolDetectedPayload) => {
    app.log.info({ event: NEW_TOOL_DETECTED, payload }, 'Event received');
  });
});
