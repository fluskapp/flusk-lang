// @generated by flusk-lang logic compiler
import type { FastifyInstance, FastifyRequest, FastifyReply } from 'fastify';

interface AggregateDailyUsageInput {
  orgId: number;
  date: string;
}

export default async function aggregateDailyUsage(
  app: FastifyInstance,
  request: FastifyRequest,
  reply: FastifyReply,
  input: AggregateDailyUsageInput,
) {
  const events = await app.platformatic.entities.telemetryEvent.find({ where: { org_id: input.org_id, date: input.date } });
  const grouped = {  };
  const results = [];
  for (const evt of events) {
    const key = evt.device_id + ':' + evt.provider + ':' + evt.model;
    if (!(grouped[key])) {
      const grouped[key] = { device_id: evt.device_id, provider: evt.provider, model: evt.model, request_count: 0, total_input_tokens: 0, total_output_tokens: 0, total_cost_usd: 0, total_latency_ms: 0, shadow_count: 0 };
    }
    const grouped[key].request_count = grouped[key].request_count + 1;
    const grouped[key].total_input_tokens = grouped[key].total_input_tokens + evt.input_tokens;
    const grouped[key].total_output_tokens = grouped[key].total_output_tokens + evt.output_tokens;
    const grouped[key].total_cost_usd = grouped[key].total_cost_usd + evt.cost_usd;
    const grouped[key].total_latency_ms = grouped[key].total_latency_ms + evt.latency_ms;
    if (!(evt.is_approved)) {
      const grouped[key].shadow_count = grouped[key].shadow_count + 1;
    }
  }
  const results = [];
  for (const entry of grouped) {
    await app.platformatic.entities.usageDaily.save({ input: { org_id: input.org_id, date: input.date, device_id: entry.device_id, provider: entry.provider, model: entry.model, request_count: entry.request_count, total_input_tokens: entry.total_input_tokens, total_output_tokens: entry.total_output_tokens, total_cost_usd: entry.total_cost_usd, total_latency_ms: entry.total_latency_ms, shadow_count: entry.shadow_count } });
  }
}
