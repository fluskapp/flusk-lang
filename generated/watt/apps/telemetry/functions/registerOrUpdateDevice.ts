// @generated by flusk-lang logic compiler
import type { FastifyInstance, FastifyRequest, FastifyReply } from 'fastify';

// now() = new Date().toISOString()

interface RegisterOrUpdateDeviceInput {
  deviceId: string;
  hostname: string;
  os: string;
  agentVersion: string;
  orgId: number;
}

export default async function registerOrUpdateDevice(
  app: FastifyInstance,
  request: FastifyRequest,
  reply: FastifyReply,
  input: RegisterOrUpdateDeviceInput,
) {
  const existing = await app.platformatic.entities.agentDevice.find({ where: { device_id: input.device_id }, limit: 1 }).then(r => r[0] ?? null);
  if (existing) {
    await app.platformatic.entities.agentDevice.save({ input: { id: existing.id, hostname: input.hostname, os: input.os, agent_version: input.agent_version, last_seen_at: new Date().toISOString(), status: 'active' } });
    return reply.send(existing);
  } else {
    const device = await app.platformatic.entities.agentDevice.save({ input: { org_id: input.org_id, device_id: input.device_id, hostname: input.hostname, os: input.os, agent_version: input.agent_version, last_seen_at: new Date().toISOString(), status: 'active' } });
    return reply.send(device);
  }
}
