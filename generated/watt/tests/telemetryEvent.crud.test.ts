// @generated by flusk-lang â€” DO NOT EDIT

import { test } from 'node:test';
import assert from 'node:assert/strict';
import { buildServer } from '@platformatic/db';

const fixture = {
  "org_id": "test",
  "device_id": "test-device_id",
  "trace_id": "test-trace_id",
  "span_id": "test-span_id",
  "provider": "test-provider",
  "model": "test-model",
  "tool_name": "test-tool_name",
  "input_tokens": "test",
  "output_tokens": "test",
  "latency_ms": "test",
  "cost_usd": 1,
  "status_code": "test",
  "is_approved": true,
  "metadata": "test"
};

test('TelemetryEvent CRUD', async (t) => {
  const app = await buildServer('./apps/db/platformatic.json');
  await app.start();
  const baseUrl = app.url;

  await t.test('POST /telemetry_events', async () => {
    const res = await fetch(`${baseUrl}/telemetry_events`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(fixture),
    });
    assert.equal(res.status, 200);
    const body = await res.json();
    assert.ok(body.id);
  });

  await t.test('GET /telemetry_events', async () => {
    const res = await fetch(`${baseUrl}/telemetry_events`);
    assert.equal(res.status, 200);
    const body = await res.json();
    assert.ok(Array.isArray(body));
    assert.ok(body.length > 0);
  });

  await t.test('PUT /telemetry_events/1', async () => {
    const res = await fetch(`${baseUrl}/telemetry_events/1`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ device_id: 'updated' }),
    });
    assert.equal(res.status, 200);
  });

  await t.test('DELETE /telemetry_events/1', async () => {
    const res = await fetch(`${baseUrl}/telemetry_events/1`, { method: 'DELETE' });
    assert.equal(res.status, 200);
  });

  await app.close();
});
